!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("isomorphic-unfetch")):"function"==typeof define&&define.amd?define(["exports","isomorphic-unfetch"],r):r(e.cep={},e.fetch)}(this,function(e,r){"use strict";function t(e){return function(r){return e(r,m)}}r=r&&r.hasOwnProperty("default")?r.default:r;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},a=function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)},s=function(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r},c=function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)},i=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.message,o=e.type,a=e.errors;n(this,r);var c=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return c.name="CepPromiseError",c.message=t,c.type=o,c.errors=a,c}return a(r,e),r}(Error),p=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.message,o=e.service;n(this,r);var a=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return a.name="ServiceError",a.message=t,a.service=o,a}return a(r,e),r}(Error),u={analyzeAndParseResponse:function(e,r){if(e.ok)return e.json();throw Error("Erro ao se conectar com o serviço "+r+".")},checkForViaCepError:function(e,r){if(e.erro===!0)throw new Error("CEP não encontrado na base do "+r+".");return e},extractCepValuesFromResponse:function(e,r){return{cep:e[r.cep].replace("-",""),state:e[r.state],city:e[r.city],neighborhood:e[r.neighborhood],street:e[r.street]}},throwApplicationError:function(e,r){var t=new p({message:e.message,service:r.toLowerCase()});throw"FetchError"===e.name&&(t.message="Erro ao se conectar com o serviço "+r+"."),t}},h=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o="CepAberto",n=t+"http://www.cepaberto.com/api/v2/ceps.json?cep="+e,a={method:"GET",mode:"cors",headers:{"content-type":"application/json;charset=utf-8",Authorization:'Token token="37bfda18fd4b423cdb6748d14ba30aa6"'}};return r(n,a).then(function(e){return u.analyzeAndParseResponse(e,o)}).then(function(e){return u.checkForViaCepError(e,o)}).then(function(e){return u.extractCepValuesFromResponse(e,{cep:"cep",state:"estado",city:"cidade",neighborhood:"bairro",street:"logradouro"})}).catch(function(e){return u.throwApplicationError(e,o)})},f={analyzeAndParseResponse:function(e){return e.ok?e.text().then(f.parseSuccessXML).then(function(e){return u.extractCepValuesFromResponse(e,{cep:"cep",state:"uf",city:"cidade",neighborhood:"bairro",street:"end"})}):e.text().then(f.parseAndextractErrorMessage).then(f.throwCorreiosError)},parseSuccessXML:function(e){try{var r=e.replace(/\r?\n|\r/g,"").match(/<return>(.*)<\/return>/)[0]||"",t=r.replace("<return>","").replace("</return>",""),o=t.split(/</).reduce(function(e,r){var t=r.split(">");return t.length>1&&t[1].length&&(e[t[0]]=t[1]),e},{});return o}catch(e){throw new Error("Não foi possível interpretar o XML de resposta.")}},parseAndextractErrorMessage:function(e){try{var r=e.match(/<faultstring>(.*)<\/faultstring>/)[0]||"",t=r.replace("<faultstring>","").replace("</faultstring>","");return t}catch(e){throw new Error("Não foi possível interpretar o XML de resposta.")}},throwCorreiosError:function(e){throw new Error(e)}},l=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o="Correios",n=t+"https://apps.correios.com.br/SigepMasterJPA/AtendeClienteService/AtendeCliente",a={method:"POST",body:'<?xml version="1.0"?>\n<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cli="http://cliente.bean.master.sigep.bsb.correios.com.br/">\n  <soapenv:Header />\n  <soapenv:Body>\n    <cli:consultaCEP>\n      <cep>'+e+"</cep>\n    </cli:consultaCEP>\n  </soapenv:Body>\n</soapenv:Envelope>",headers:{"Content-Type":"text/xml;charset=UTF-8","cache-control":"no-cache"}};return r(n,a).then(f.analyzeAndParseResponse).catch(function(e){return u.throwApplicationError(e,o)})},d=function(e){var t="ViaCEP",o="https://viacep.com.br/ws/"+e+"/json/",n={method:"GET",mode:"cors",headers:{"content-type":"application/json;charset=utf-8"}};return r(o,n).then(function(e){return u.analyzeAndParseResponse(e,t)}).then(function(e){return u.checkForViaCepError(e,t)}).then(function(e){return u.extractCepValuesFromResponse(e,{cep:"cep",state:"uf",city:"localidade",neighborhood:"bairro",street:"logradouro"})}).catch(function(e){return u.throwApplicationError(e,t)})},m="https://cors-anywhere.herokuapp.com/",y=8,v="undefined"==typeof process?t(h):h,g="undefined"==typeof process?t(l):l,b="undefined"==typeof process?t(d):d,E=function(e){return new Promise(function(r,t){return Promise.resolve(e).then(t,r)})};Promise.any=function(e){return E(Promise.all([].concat(c(e)).map(E)))};var w={validateInputType:function(e){var r="undefined"==typeof e?"undefined":o(e);if("number"===r||"string"===r)return e;throw new i({message:"Erro ao inicializar a instância do CepPromise.",type:"validation_error",errors:[{message:"Você deve chamar o construtor utilizando uma String ou um Number.",service:"cep_validation"}]})},removeSpecialCharacters:function(e){return e.toString().replace(/\D+/g,"")},leftPadWithZeros:function(e){return"0".repeat(y-e.length)+e},validateInputLength:function(e){if(e.length<=y)return e;throw new i({message:"CEP deve conter exatamente "+y+" caracteres.",type:"validation_error",errors:[{message:"CEP informado possui mais do que "+y+" caracteres.",service:"cep_validation"}]})},fetchCepFromServices:function(e){return Promise.any([v(e),g(e),b(e)])},handleServicesError:function(e){if(void 0!==e.length)throw new i({message:"Todos os serviços de CEP retornaram erro.",type:"service_error",errors:e});throw e},throwApplicationError:function(e){var r=e.message,t=e.type,o=e.errors;return new i({message:r,type:t,errors:o})}},P=function(e){return Promise.resolve(e).then(w.validateInputType).then(w.removeSpecialCharacters).then(w.validateInputLength).then(w.leftPadWithZeros).then(w.fetchCepFromServices).catch(w.handleServicesError).catch(w.throwApplicationError)};e.searchCEP=P,e.default=P,Object.defineProperty(e,"__esModule",{value:!0})});